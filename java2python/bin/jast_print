#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""

"""
import copy
import optparse
import sys

from antlr3 import FileStream, StringStream
from antlr3.dottreegen import DOTTreeGenerator

from java2python.parser import JavaParser as Jp
from java2python.parser.extra import LocalTokenStream
from java2python.parser.JavaLexer import JavaLexer

try:
    import psyco
except (ImportError, ):
    pass
else:
    psyco.full()


def buildTokenMap():
    return dict(
        [(m, l) for l, m in [(k, getattr(Jp, k)) for k in dir(Jp)] if isinstance(m, int)]
        )
tokenMap = buildTokenMap()


def load_trees((stream_type, source)):
    stream = stream_type(source)
    lexer = JavaLexer(stream)
    tokens = LocalTokenStream(lexer)
    parser = Jp.JavaParser(tokens)
    yield parser.javaSource().tree


def show_trees(trees):
    for tree in trees:
        show(tree)


def show(node, level=0):
    ##print "###", type(node)
    txt = node.getText()
    typ = tokenMap.get(node.getType(), '?')
    args = ('    '*level,
            typ,
            (' : ' if txt != typ else ''),
            (txt if txt != typ else ''))
    print '%s%s%s%s' % args
    comment = getattr(node, 'comment', None)
    if comment:
        print '%s%s : %s' % ('    '*level, 'COMMENT_SEQ', node.comment)

    for i in range(node.getChildCount()):
        show(node.getChild(i), level+1)
    return 0


def cli_options(argv):
    parser = optparse.OptionParser(version='%prog 0.3')
    parser.add_option('-i', '--input', dest='inputfile',
		      help='read INPUTFILE',
		      metavar='INPUTFILE', default=None)
    options, args = parser.parse_args(argv)
    if len(args) == 2:
	options.inputfile = args[1]
    return options, args


if __name__ == '__main__':
    options, args = cli_options(sys.argv)
    src = options.inputfile
    try:
        locs = ((StringStream, sys.stdin.read())
                if src == '-' else (FileStream, src))
        trees = load_trees(locs)
        sys.exit(show_trees(trees))
    except (Exception, ), exc:
        print exc
        raise

st = stringtemplate3 
